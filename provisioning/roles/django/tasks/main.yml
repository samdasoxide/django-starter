# Handles the set-up of Django
---
- name: run production configuration
  include: production.yml
  when: env == 'production'

- name: install system package dependencies
  apt:
    name: "{{ item }}"
    state: latest
    update_cache: yes
    cache_valid_time: "{{ apt_cache_valid_time }}"
  with_items:
    # requests[security]
    - python-cffi
    - libffi-dev
    - libssl-dev
    # geo django
    - libgeos-dev
    # wagtail
    - libjpeg-dev
    - libtiff-dev
    - zlib1g-dev
    - libfreetype6-dev
    - liblcms2-dev
  become: yes

- name: install requirements
  pip:
    requirements: "{{ base_dir }}/requirements/{{ env }}.txt"
    virtualenv: "{{ virtualenv_path }}"
  become: true
  become_user: "{{ deployment_user }}"

- name: django migrate
  django_manage:
    command: migrate
    settings: "{{ django_settings_module }}"
    virtualenv: "{{ virtualenv_path }}"
    app_path: "{{ django_dir }}"
  become: true
  become_user: "{{ deployment_user }}"

- name: django collectstatic
  django_manage:
    command: collectstatic
    settings: "{{ django_settings_module }}"
    virtualenv: "{{ virtualenv_path }}"
    app_path: "{{ django_dir }}"
  become: true
  become_user: "{{ deployment_user }}"
